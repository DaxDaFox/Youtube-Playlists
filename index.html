<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>YouTube Playlists</title>
<!-- CSP meta tag to allow Google scripts -->
<meta http-equiv="Content-Security-Policy" content="script-src 'self' https://accounts.google.com https://apis.google.com https://www.gstatic.com; object-src 'none';" />
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #status { margin-bottom: 10px; }
  #playlists { margin-top: 20px; }
  .playlist-btn { display: block; margin: 5px 0; }
</style>
</head>
<body>

<h1>YouTube Playlists</h1>
<div id="status">Not signed in.</div>
<div id="g_id_onload"
     data-client_id="656269912892-ah9lfkjdh8e6q40hrmh4ogurc336gqqr.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-auto_prompt="false"
     data-scope="https://www.googleapis.com/auth/youtube.force-ssl">
</div>
<div class="g_id_signin" data-type="standard"></div>

<div id="playlists"></div>

<!-- Load Google Identity Services SDK -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
  let accessToken = '';

  // Initialize sign-in button
  window.onload = () => {
    // Attach click handler to the sign-in button
    document.querySelector('.g_id_signin').addEventListener('click', () => {
      google.accounts.id.prompt(); // Show the account chooser prompt
    });
  };

  // Handle the credential response after sign-in
  async function handleCredentialResponse(response) {
    console.log('Encoded JWT ID token:', response.credential);
    // Decode the JWT token to get user info
    const jwt = parseJwt(response.credential);
    document.getElementById('status').innerText = `Signed in as ${jwt.name}`;

    // Now, exchange the ID token for an access token
    // Since GIS doesn't directly give an access token, you'll need to do OAuth flow server-side
    // For simplicity, in this example, you'll need to implement OAuth properly to get access tokens
    // or use the OAuth flow with the Google API client library.

    // **Note**: For full access to YouTube API, you need to implement OAuth 2.0 flow with server-side exchange.
    // Here, for demonstration, assume you have an access token.

    // For testing, you can hardcode an access token or implement OAuth flow server-side.
    // Alternatively, you can switch back to gapi.auth2 for client-side OAuth.

    // For demonstration, assume we have an access token (replace with your method)
    // accessToken = 'YOUR_ACCESS_TOKEN';

    // If you implement OAuth server-side, after obtaining accessToken, call fetchPlaylists()
    // fetchPlaylists();
  }

  // Utility to decode JWT
  function parseJwt (token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  }

  // Placeholder function to fetch playlists (requires OAuth access token)
  async function fetchPlaylists() {
    if (!accessToken) {
      alert('Access token not available. Implement OAuth flow to get it.');
      return;
    }

    try {
      const response = await fetch(
        'https://www.googleapis.com/youtube/v3/playlists?part=snippet&mine=true',
        {
          headers: {
            Authorization: 'Bearer ' + accessToken
          }
        }
      );
      const data = await response.json();
      console.log('Playlists data:', data);
      if (data.error) {
        alert('Error: ' + data.error.message);
        return;
      }
      displayPlaylists(data.items);
    } catch (err) {
      alert('Fetch error: ' + err);
    }
  }

  // Display playlists
function displayPlaylists(playlists) {
  const container = document.getElementById('playlists');
  container.innerHTML = '';

  if (!playlists || playlists.length === 0) {
    container.innerText = 'No playlists found.';
    return;
  }

  playlists.forEach(pl => {
    const btn = document.createElement('button');
    btn.className = 'playlist-btn';
    btn.innerText = pl.snippet.title;
    btn.onclick = () => {
      alert('You clicked playlist: ' + pl.snippet.title);
    };
    container.appendChild(btn);
  });
}
</script>
</body>
</html>
